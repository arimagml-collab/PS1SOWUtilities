# 設計レビューとリファクタリング提案

## 対象
- エントリポイント: `PS1SNOWUtilities.ps1`
- コアモジュール: `modules/Core/*.psm1`
- 機能モジュール: `modules/Features/*.psm1`
- ドキュメント: `README.md`

---

## 現状の設計評価（要点）

### 1. 良い点
- **Core / Features 分離**の方向性が明確で、機能ごとの読み込み可否も管理できる構成。
- `Import-OptionalFeatureModule` により、配布時に機能を除外できる柔軟性がある。
- i18n・設定保存・ServiceNow API 呼び出しがある程度ラップされており、責務をまとめる意図が見える。

### 2. 主な課題
- エントリポイント（`PS1SNOWUtilities.ps1`）が巨大で、**UI・ユースケース・インフラ処理が混在**しやすい。
- グローバル状態（`$script:Settings` など）依存が強く、変更影響範囲の把握が難しい。
- API 呼び出しの抽象化はあるものの、機能実装ごとに入力検証・ログ・例外処理の粒度が揃わない可能性。
- 回帰検証が `tests/phase3-check.ps1` 中心で、**ユニットテスト観点の自動化余地**が大きい。

---

## 優先度付きリファクタリング提案

## P0（最優先）

### A. Feature 層中心の責務明確化（Application 新設は行わない）
**目的**: 現行構成を維持しつつ、保守性・テスト容易性を改善。

- `modules/Application/` などの新規レイヤーは追加しない。
- ユースケース実装は既存 `modules/Features/*.psm1` に集約し、機能単位の責務を明文化する。
- WinForms のイベントハンドラは「入力収集 + Feature 呼び出し + UI反映」のみに限定する。
- **Feature ファイルを省いた場合に機能なしとして扱える現行仕様を維持**し、`Import-OptionalFeatureModule` 前提の配布柔軟性を崩さない。

**期待効果**:
- レイヤー新設による構成の分散を避け、既存運用との整合性を維持。
- 機能追加時の実装場所を `Features` に統一し、追跡性を向上。

### B. 重複・散在処理の統合
**目的**: バグ混入余地の低減。

- `PS1SNOWUtilities.ps1` 内の重複関数定義（例: `Sync-AuthTypeFromSelection`）を解消。
- API 認証分岐・ログ文言・例外ハンドリングの共通ルールを `Core` に寄せる。
- タブごとの「開始ログ / 成功ログ / 失敗ログ」のフォーマットを統一。

**期待効果**:
- レビュー容易化。
- 仕様変更（認証方式追加、ログ形式変更）時の修正箇所削減。

---

## P1（高優先）

### C. 型付き設定モデル + バリデータ
**目的**: 設定破損・互換性問題の抑止。

- `settings.json` 読み込み時にバージョン情報（`settingsVersion`）を保持。
- `ConvertFrom-Json` 後の生データをそのまま使わず、正規化関数を通す。
- `Test-Settings` 相当の検証を導入し、UI 表示前に不整合を修復・警告。

**期待効果**:
- 将来項目追加時の後方互換が取りやすい。
- 利用者環境差分による不具合の早期発見。

### D. ServiceNow API クライアントの責務強化
**目的**: 通信品質と観測性の向上。

- リトライポリシー（429/5xx）を `Core/ServiceNowClient.psm1` 側へ集約。
- 1リクエスト単位の `requestId` を採番し、ログ相関可能にする。
- タイムアウト、再試行回数、バックオフを設定化。

**期待効果**:
- ネットワーク不安定時の回復性向上。
- 障害解析時間の短縮。

---

## P2（中優先）

### E. ロギング改善（構造化 + レベル導入）
**目的**: 運用保守性の改善。

- 既存テキストログに加え、任意で JSON Lines 形式を出力。
- `INFO/WARN/ERROR/DEBUG` レベル導入。
- 個人情報・秘密情報のマスキング方針を共通化。

### F. i18n運用の品質ゲート
**目的**: 文言欠落の予防。

- `locales/ja.json` を基準に `en.json` との差分チェックを CI スクリプト化。
- 欠損キー検出時にビルド警告（または失敗）を出す。

---

## 目安となる実行計画（3スプリント想定）

1. **Sprint 1**
   - P0-A/B 実施（Feature 層の責務明確化、重複解消）
   - Feature の有無による起動・動作差分を含むスモークテストを手順化
2. **Sprint 2**
   - P1-C/D 実施（設定モデル、APIクライアント強化）
   - 失敗系テスト（認証失敗、タイムアウト、429）を追加
3. **Sprint 3**
   - P2-E/F 実施（構造化ログ、i18n CI）
   - ドキュメント更新（運用・障害対応手順）

---

## 最小実装サンプル方針（参考）

- まず Export だけ `Features` 内で責務分離し、設計パターンを固定。
- 以降は Attachment Harvester / View Editor / Truncate を同型で横展開。
- 1機能ずつ段階移行し、Big Bang 変更を避ける。
- 各段階で「対象 Feature ファイルを除外した際に機能が読み込まれない」ことを確認する。

---

## 補足

- 本提案は現行の WinForms 採用を前提にした「段階的改善」案。
- 将来的に UI 技術を変更する場合も、Features / Core の責務分離を先に安定化しておくと移行コストを抑えられる。
